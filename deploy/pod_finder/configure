#!/bin/bash
PF_HOME=`pwd`
PF_NAME=pod_finder
PF_BIN=$PF_HOME/bin/$PF_NAME
NGX="<<@PODFINDER_NGX_PATH>>" #path to nginx executable,                                                                    ex: $accelerator_home/sbin/nginx
NGX_PREFIX="<<@PODFINDER_NGX_PREFIX>>"  #prefix of nginx                                                                    ex: $accelerator_home
NGX_CONF="<<@PODFINDER_NGX_CONF_PATH>>" #path from ngx prefix to nginx conf,                                                ex: conf/nginx.conf
PORT="<<@PODFINDER_POD_DEFAULT_PORT>>"  #default pod port if multiple port is available,                                    ex: 8000
REPORT="<<@PODFINDER_REPORT>>"  #polling interval, second,                                                                  ex: 3
ETCD="<<@PODFINDER_ETCD>>"  #url of etcd,                                                                                   ex: 10.128.112.15:2379
SVC="<<@PODFINDER_SVC_NAME>>"  #ngx upstream server name, seperated by ",",                                                 ex: svc1,svc2,svc3
POD="<<@PODFINDER_POD_NAME>>"  #corresponding k8s pod name, order should be the same with upstream name, seperated by ",",  ex: pod1,pod2,pod3

#******
# modifying supervisord conf
#******
super_mod() {
  echo "[program:$PF_NAME]" | sudo tee -a $SUPER_CONF
  echo "command=$PF_BIN -ngx $NGX -p $NGX_PREFIX -c $NGX_CONF -port $PORT -report $REPORT -restful $ETCD -service $SVC -pod $POD" | sudo tee -a $SUPER_CONF
  echo "redirect_stderr=true" | sudo tee -a $SUPER_CONF
  echo "stdout_logfile=$PF_HOME/stdout.log" | sudo tee -a $SUPER_CONF
}

super_mod


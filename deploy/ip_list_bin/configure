#!/bin/bash

WATCHLIST=/etc/supervisord.conf
IL_HOME=`pwd`
IL_NAME=ip_list
IL_PATH=$IL_HOME/bin/$IL_NAME
SL_PATH=$IL_HOME/conf/srv_list.conf
EL_PATH=$IL_HOME/logs/error.log
CH_PATH=$IL_HOME/data/ip_list
CTL_SCRIPT=$IL_HOME/ip_list
SUICIDE=$IL_HOME/ip_list_restarter

#******
# starting binary checking
#******
binary_check(){
  echo "Stage 1: Begin binary checking..."
  _cat=`which cat`
  if [ ! -x $_cat ]; then 
    echo "cat not exists! ($_cat)"
    exit 1
  fi

  _wc=`which wc`
  if [ ! -x $_wc ]; then
    echo "wc not exists! ($_wc)"
    exit 1
  fi

  _grep=`which grep`
  if [ ! -x $_grep ]; then
    echo "grep not exists! ($_grep)"
    exit 1
  fi

  _awk=`which awk`
  if [ ! -x $_awk ]; then
    echo "awk not exists! ($_awk)"
    exit 1
  fi

  _sed=`which sed`
  if [ ! -x $_sed ]; then
    echo "sed not exists! ($_sed)"
    exit 1
  fi

  echo "Stage 1: Binary checking... done"
  echo "------"
}

#******
# show configuration
#******
show_conf() {
  echo $WATCHLIST
}

#******
# modifying supervisord conf
#******
super_mod() {
  #echo_supervisord_conf > $WATCHLIST

  mkdir -p $IL_HOME/logs
  echo "$IL_PATH -cache $CH_PATH -list $SL_PATH -logfile $EL_PATH -brokers $BROKERS -backend http://$BACKEND/v1/appid" | sudo tee -a $WATCHLIST
}

update_ctl () {
  $_sed -i -e "s/BROKERS=\"<<BROKERS>>\"/BROKERS=\"$BROKERS\"/g" $CTL_SCRIPT
  $_sed -i -e "s@BACKEND=\"<<BACKEND>>\"@BACKEND=\"$BACKEND\"@g" $CTL_SCRIPT
}

gen_suicide () {
  echo "#/bin/bash" > $SUICIDE
  echo "cd $IL_HOME" >> $SUICIDE
  echo "$CTL_SCRIPT restart" >> $SUICIDE
  chmod +x $SUICIDE
}

echo_usage () {
  echo "Usage: $0 <path to agentdog watch list> <broker list> <zone code backend>"
}

start_config () {
  binary_check
  super_mod
  update_ctl
  gen_suicide
}

if [[ "$#" -ne 3 ]]; then
  echo "Illegal number of parameters, expected 3, got $#"
  echo_usage
else
  WATCHLIST=$1
  BROKERS=$2
  BACKEND=$3
  start_config
fi


#!/bin/bash

SUPER_CONF=/etc/supervisord.conf
IL_HOME=`pwd`
IL_NAME=ip_list
IL_PATH=$IL_HOME/bin/$IL_NAME
SL_PATH=$IL_HOME/conf/srv_list.conf
EL_PATH=$IL_HOME/logs/error.log
CH_PATH=$IL_HOME/data/ip_list
HOST="<<@KEYSERVER_INT_IP>>"
BROKERS="<<@KEYSERVER_KFK_BROKERS>>"
BACKEND="http://10.10.20.60:30111/v1/appid"

#******
# starting binary checking
#******
binary_check(){
  echo "Stage 1: Begin binary checking..."
  _cat=`which cat`
  if [ ! -x $_cat ]; then 
    echo "cat not exists! ($_cat)"
    exit 1
  fi

  _wc=`which wc`
  if [ ! -x $_wc ]; then
    echo "wc not exists! ($_wc)"
    exit 1
  fi

  _grep=`which grep`
  if [ ! -x $_grep ]; then
    echo "grep not exists! ($_grep)"
    exit 1
  fi

  _awk=`which awk`
  if [ ! -x $_awk ]; then
    echo "awk not exists! ($_awk)"
    exit 1
  fi

  _sed=`which sed`
  if [ ! -x $_sed ]; then
    echo "sed not exists! ($_sed)"
    exit 1
  fi

  echo "Stage 1: Binary checking... done"
  echo "------"
}

#******
# show configuration
#******
show_conf() {
  echo $SUPER_CONF
}

#******
# modifying supervisord conf
#******
super_mod() {
  #echo_supervisord_conf > $SUPER_CONF

  mkdir -p $IL_HOME/logs
  echo "[program:$IL_NAME]" | sudo tee -a $SUPER_CONF
  echo "command=$IL_PATH -cache=$CH_PATH -list=$SL_PATH -logfile=$EL_PATH -host=$HOST -brokers=$BROKERS -backend $BACKEND" | sudo tee -a $SUPER_CONF
}

SUPER_CONF=$1
binary_check
#show_conf
super_mod
